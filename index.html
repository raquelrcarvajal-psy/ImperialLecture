<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Friend · Enemy</title>
<link href="https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,600;1,400&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">

<style>
/* ═══════════════════════════════════════════
   DESIGN SYSTEM — Academic editorial, light
═══════════════════════════════════════════ */
:root {
  --ink:      #0f0e0c;
  --ink2:     #3a3830;
  --ink3:     #8a857a;
  --paper:    #faf9f6;
  --paper2:   #f2f0eb;
  --rule:     #dddad3;
  --friend:   #1a6b3c;
  --enemy:    #b5261e;
  --friend-l: #e8f5ee;
  --enemy-l:  #fbeaea;
  --accent:   #2a4b8c;
  --r: 2px;
  --mono: 'DM Mono', monospace;
  --serif: 'EB Garamond', Georgia, serif;
}

* { margin:0; padding:0; box-sizing:border-box; }

html, body {
  background: var(--paper);
  color: var(--ink);
  font-family: var(--serif);
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
}

/* ── TOPBAR ── */
#topbar {
  position: fixed; top:0; left:0; right:0; z-index:200;
  height: 52px;
  background: var(--ink);
  display: flex; align-items: stretch;
}
.tab {
  display: flex; align-items: center; justify-content: center;
  padding: 0 28px;
  color: var(--ink3);
  font-family: var(--mono); font-size: 9px; letter-spacing: 3px; text-transform: uppercase;
  cursor: pointer; transition: color .2s; border: none; background: transparent;
  border-right: 1px solid #2a2820;
  position: relative;
}
.tab::after {
  content:''; position:absolute; bottom:0; left:0; right:0; height:2px;
  background: transparent; transition: background .2s;
}
.tab.active { color: var(--paper); }
.tab.active::after { background: var(--friend); }
.tab.active.etab::after { background: var(--enemy); }

.topbar-brand {
  flex:1; display:flex; align-items:center; justify-content:center;
  color: #4a4840;
  font-family: var(--serif); font-size: 13px; letter-spacing: 5px;
  text-transform: uppercase; font-style: italic;
}

/* ── VIEWS ── */
.view { display:none; padding-top:52px; min-height:100vh; }
.view.active { display:block; }

/* ════════════════════════════════════════
   PARTICIPANT VIEW
════════════════════════════════════════ */
#participant-view.active {
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  min-height: 100vh; padding: 52px 32px 48px;
}

.phase-strip {
  display: flex; gap: 6px; margin-bottom: 40px;
}
.pstrip-dot {
  height: 3px; width: 28px; border-radius: 1px;
  background: var(--rule); transition: all .4s;
}
.pstrip-dot.f-active { background: var(--friend); width: 44px; }
.pstrip-dot.e-active { background: var(--enemy);  width: 44px; }
.pstrip-dot.done     { background: var(--paper2); }

.q-label {
  font-family: var(--mono); font-size: 9px; letter-spacing: 4px;
  text-transform: uppercase; color: var(--ink3); margin-bottom: 10px;
  text-align: center;
}

.q-text {
  font-family: var(--serif); font-size: clamp(38px, 11vw, 72px);
  font-weight: 600; line-height: 1.05; text-align: center;
  margin-bottom: 4px; transition: color .5s;
}
.q-text.friend { color: var(--friend); }
.q-text.enemy  { color: var(--enemy); }

.q-sub {
  font-family: var(--serif); font-size: 14px; font-style: italic;
  color: var(--ink3); text-align: center; margin-bottom: 44px;
}

.input-wrap { width: 100%; max-width: 360px; display: flex; flex-direction: column; gap: 10px; }

.word-field {
  width: 100%; padding: 16px 20px;
  background: white; border: 1.5px solid var(--rule); border-radius: var(--r);
  font-family: var(--serif); font-size: 26px; font-weight: 600;
  text-align: center; color: var(--ink); outline: none;
  transition: border-color .25s, box-shadow .25s;
}
.word-field::placeholder { color: var(--rule); font-style: italic; font-weight: 400; }
.word-field:focus { border-color: var(--friend); box-shadow: 0 0 0 3px rgba(26,107,60,.1); }
.word-field.enemy:focus { border-color: var(--enemy); box-shadow: 0 0 0 3px rgba(181,38,30,.1); }
.word-field:disabled { background: var(--paper2); opacity: .6; }

.submit-btn {
  width: 100%; padding: 15px;
  border: none; border-radius: var(--r);
  font-family: var(--mono); font-size: 10px; letter-spacing: 3px; text-transform: uppercase;
  cursor: pointer; transition: all .2s; font-weight: 500;
}
.submit-btn.friend { background: var(--friend); color: white; }
.submit-btn.enemy  { background: var(--enemy);  color: white; }
.submit-btn:hover:not(:disabled) { opacity: .88; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(0,0,0,.15); }
.submit-btn:disabled { opacity: .35; cursor: not-allowed; transform: none; box-shadow: none; }

.p-status {
  text-align: center; font-family: var(--mono); font-size: 9px; letter-spacing: 3px;
  text-transform: uppercase; color: var(--ink3); min-height: 16px; transition: color .3s;
}
.p-status.ok { color: var(--friend); }
.p-status.ok.enemy { color: var(--enemy); }

/* waiting screen */
#wait-screen { display:none; flex-direction:column; align-items:center; gap:16px; padding-top:80px; text-align:center; }
#wait-screen.show { display:flex; }
.wait-icon { font-size: 40px; animation: breathe 3s ease-in-out infinite; }
@keyframes breathe { 0%,100%{opacity:.3;transform:scale(.95)} 50%{opacity:1;transform:scale(1)} }
.wait-title { font-family:var(--serif); font-size:26px; color:var(--ink2); }
.wait-sub   { font-family:var(--mono); font-size:9px; letter-spacing:3px; color:var(--ink3); text-transform:uppercase; }

/* ════════════════════════════════════════
   PRESENTER VIEW
════════════════════════════════════════ */
#presenter-view { background: var(--paper); }

.pres-header {
  padding: 20px 32px 16px;
  border-bottom: 1px solid var(--rule);
  display: flex; align-items: center; justify-content: space-between;
  flex-wrap: wrap; gap: 16px;
  background: white;
}

.pres-meta { display: flex; align-items: center; gap: 28px; }

.phase-pill {
  display: inline-flex; align-items: center; gap: 8px;
  padding: 6px 14px; border-radius: 20px;
  font-family: var(--mono); font-size: 9px; letter-spacing: 3px; text-transform: uppercase;
  transition: all .4s;
}
.phase-pill.friend { background: var(--friend-l); color: var(--friend); }
.phase-pill.enemy  { background: var(--enemy-l);  color: var(--enemy); }
.phase-pill-dot { width:6px; height:6px; border-radius:50%; animation: blink 1.4s ease-in-out infinite; }
.phase-pill.friend .phase-pill-dot { background: var(--friend); }
.phase-pill.enemy  .phase-pill-dot { background: var(--enemy); }
@keyframes blink { 0%,100%{opacity:.3} 50%{opacity:1} }

.stat { text-align:center; }
.stat-n { font-family:var(--serif); font-size:26px; font-weight:600; line-height:1; }
.stat-l { font-family:var(--mono); font-size:7px; letter-spacing:3px; color:var(--ink3); text-transform:uppercase; margin-top:2px; }

.ctrl-group { display:flex; gap:8px; flex-wrap:wrap; }

.btn {
  padding: 8px 16px; border-radius: var(--r);
  font-family: var(--mono); font-size: 8px; letter-spacing: 2px; text-transform: uppercase;
  cursor: pointer; transition: all .18s; border: 1.5px solid var(--rule);
  background: transparent; color: var(--ink2);
}
.btn:hover { border-color: var(--ink2); color: var(--ink); }
.btn.friend-btn { border-color: var(--friend); color: var(--friend); }
.btn.friend-btn:hover { background: var(--friend-l); }
.btn.enemy-btn  { border-color: var(--enemy);  color: var(--enemy); }
.btn.enemy-btn:hover  { background: var(--enemy-l); }
.btn.primary-btn { background: var(--accent); border-color: var(--accent); color: white; }
.btn.primary-btn:hover { opacity:.88; }
.btn:disabled { opacity:.3; cursor:not-allowed; }

/* diversity bars */
.div-row {
  display: flex; align-items: center;
  padding: 10px 32px; background: var(--paper2);
  border-bottom: 1px solid var(--rule); flex-wrap: wrap; gap: 0;
}
.div-block { display:flex; align-items:center; gap:10px; flex:1; min-width:200px; padding: 4px 0; }
.div-lbl { font-family:var(--mono); font-size:8px; letter-spacing:2px; color:var(--ink3); text-transform:uppercase; width:110px; flex-shrink:0; }
.div-track { flex:1; height:3px; background:var(--rule); border-radius:2px; overflow:hidden; }
.div-fill { height:100%; border-radius:2px; transition:width .9s cubic-bezier(.4,0,.2,1); }
.div-fill.friend { background: var(--friend); }
.div-fill.enemy  { background: var(--enemy); }
.div-pct { font-family:var(--mono); font-size:10px; width:34px; text-align:right; flex-shrink:0; }
.div-pct.friend { color:var(--friend); }
.div-pct.enemy  { color:var(--enemy); }
.div-sep { width:1px; height:28px; background:var(--rule); margin:0 24px; flex-shrink:0; }
@media(max-width:600px){ .div-sep{display:none;} }

/* main cloud area */
.clouds-wrap {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 1px; background: var(--rule);
  height: calc(100vh - 162px);
}
@media(max-width:700px){
  .clouds-wrap { grid-template-columns:1fr; height:auto; }
  .cloud-panel { height: 52vw; min-height: 240px; }
}

.cloud-panel {
  background: var(--paper); position:relative; overflow:hidden;
  display:flex; flex-direction:column;
}

.panel-head {
  padding: 14px 20px 10px; flex-shrink:0;
  border-bottom: 1px solid var(--rule); background: white;
  display: flex; align-items: baseline; gap: 12px;
}
.panel-title {
  font-family: var(--mono); font-size: 9px; letter-spacing: 4px; text-transform: uppercase;
}
.panel-title.friend { color: var(--friend); }
.panel-title.enemy  { color: var(--enemy); }
.panel-stats { font-family:var(--mono); font-size:8px; color:var(--ink3); letter-spacing:1px; }

.cloud-area { flex:1; position:relative; overflow:hidden; }

.word-tag {
  position: absolute;
  font-family: var(--serif); font-weight: 600;
  white-space: nowrap; pointer-events: none;
  transform-origin: center;
  animation: wIn .45s cubic-bezier(.34,1.4,.64,1) both;
}
@keyframes wIn {
  from { transform: scale(0) rotate(var(--wr)); opacity:0; }
  to   { transform: scale(1) rotate(var(--wr)); opacity: var(--wo); }
}

.sidebar-list {
  position: absolute; right:0; top:0; bottom:0; width:100px;
  background: linear-gradient(to right, transparent, var(--paper) 18%);
  padding: 14px 8px 14px 20px;
  overflow-y: auto; display:flex; flex-direction:column; gap:3px;
}
.sidebar-list::-webkit-scrollbar { width:2px; }
.sidebar-list::-webkit-scrollbar-thumb { background:var(--rule); }

.sitem {
  display:flex; justify-content:space-between;
  font-family:var(--mono); font-size:8px; letter-spacing:1px; padding:2px 4px;
}
.sitem-w { overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.sitem-c { opacity:.45; margin-left:4px; flex-shrink:0; }

.empty-state {
  position:absolute; inset:0; display:flex; flex-direction:column;
  align-items:center; justify-content:center; gap:6px; pointer-events:none;
}
.empty-state-icon { font-size:32px; opacity:.15; }
.empty-state-txt  { font-family:var(--mono); font-size:8px; letter-spacing:3px; color:var(--ink3); text-transform:uppercase; }

/* ════════════════════════════════════════
   ANALYSIS OVERLAY
════════════════════════════════════════ */
#analysis-overlay {
  display: none;
  position: fixed; inset:0; z-index:500;
  background: rgba(15,14,12,.85);
  backdrop-filter: blur(4px);
  align-items: center; justify-content: center;
  padding: 20px;
}
#analysis-overlay.show { display:flex; }

#analysis-panel {
  background: var(--paper); border-radius: 4px;
  width: 100%; max-width: 960px;
  max-height: 90vh; overflow: hidden;
  display: flex; flex-direction: column;
  box-shadow: 0 32px 80px rgba(0,0,0,.4);
}

.analysis-header {
  padding: 20px 28px 16px;
  border-bottom: 1px solid var(--rule);
  display: flex; align-items: center; justify-content: space-between;
}
.analysis-title { font-family:var(--serif); font-size:22px; font-weight:600; }
.analysis-actions { display:flex; gap:8px; }

.analysis-body {
  flex:1; overflow-y:auto; padding:28px;
  display: flex; flex-direction: column; gap: 28px;
}

#scatter-canvas {
  width: 100%; border: 1px solid var(--rule); border-radius: 2px;
  background: white; display:block;
}

.clusters-grid { display:grid; grid-template-columns:1fr 1fr; gap:16px; }

.cluster-card {
  border: 1px solid var(--rule); border-radius: 2px; padding:16px;
  background: white;
}
.cluster-card-head {
  font-family:var(--mono); font-size:8px; letter-spacing:3px; text-transform:uppercase;
  margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid var(--rule);
}
.cluster-card-head.friend { color:var(--friend); }
.cluster-card-head.enemy  { color:var(--enemy); }

.cluster-item {
  display:flex; align-items:baseline; gap:8px; margin-bottom:6px;
}
.cluster-name { font-family:var(--serif); font-size:16px; font-weight:600; }
.cluster-words { font-family:var(--mono); font-size:8px; color:var(--ink3); letter-spacing:1px; }

.metrics-row {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:12px;
}
.metric-card {
  background:white; border:1px solid var(--rule); border-radius:2px;
  padding:16px; text-align:center;
}
.metric-val { font-family:var(--serif); font-size:28px; font-weight:600; }
.metric-val.friend { color:var(--friend); }
.metric-val.enemy  { color:var(--enemy); }
.metric-lbl { font-family:var(--mono); font-size:8px; letter-spacing:2px; color:var(--ink3); text-transform:uppercase; margin-top:4px; }
.metric-note { font-family:var(--serif); font-size:11px; font-style:italic; color:var(--ink3); margin-top:3px; }

.analysis-loading {
  display:flex; flex-direction:column; align-items:center; gap:16px; padding:48px;
}
.spinner {
  width:36px; height:36px; border:2px solid var(--rule); border-top-color:var(--accent);
  border-radius:50%; animation:spin 1s linear infinite;
}
@keyframes spin { to{transform:rotate(360deg)} }
.loading-txt { font-family:var(--mono); font-size:9px; letter-spacing:3px; color:var(--ink3); text-transform:uppercase; }

.analysis-error {
  padding:32px; text-align:center;
  font-family:var(--serif); font-size:16px; color:var(--enemy);
}

.btn.export-btn {
  background: var(--ink); border-color: var(--ink); color: var(--paper);
  position:relative; overflow:hidden;
}
.btn.export-btn::after {
  content:''; position:absolute; inset:0;
  background: linear-gradient(135deg, transparent 40%, rgba(255,255,255,.1) 60%, transparent 70%);
  transform: translateX(-100%); transition: transform .5s;
}
.btn.export-btn:hover::after { transform: translateX(100%); }
</style>
</head>
<body>

<!-- TOP BAR -->
<div id="topbar">
  <button class="tab active" id="tab-p" onclick="switchTab('participant')">Participant</button>
  <button class="tab etab"   id="tab-r" onclick="switchTab('presenter')">Presenter</button>
  <div class="topbar-brand">Friend · Enemy</div>
</div>

<!-- ══════════ PARTICIPANT VIEW ══════════ -->
<div id="participant-view" class="view active">
  <div id="form-screen">
    <div class="phase-strip">
      <div class="pstrip-dot f-active" id="sd0"></div>
      <div class="pstrip-dot" id="sd1"></div>
    </div>
    <div class="q-label" id="q-phase-label">Phase 1 of 2</div>
    <div class="q-text friend" id="q-text">What is a friend?</div>
    <div class="q-sub">One word only</div>
    <div class="input-wrap">
      <input class="word-field" id="word-field" type="text" maxlength="30"
             placeholder="your word…" autocomplete="off" autocorrect="off"
             spellcheck="false" inputmode="text"/>
      <button class="submit-btn friend" id="submit-btn" onclick="submitWord()">Submit →</button>
      <div class="p-status" id="p-status"></div>
    </div>
  </div>
  <div id="wait-screen">
    <div class="wait-icon">◎</div>
    <div class="wait-title" id="wait-title">Please wait</div>
    <div class="wait-sub" id="wait-sub">The presenter will activate the next phase</div>
  </div>
</div>

<!-- ══════════ PRESENTER VIEW ══════════ -->
<div id="presenter-view" class="view">

  <div class="pres-header">
    <div class="pres-meta">
      <div class="phase-pill friend" id="phase-pill">
        <div class="phase-pill-dot"></div>
        <span id="phase-pill-text">Phase: Friend</span>
      </div>
      <div class="stat">
        <div class="stat-n" id="cnt-f">0</div>
        <div class="stat-l">friend resp.</div>
      </div>
      <div class="stat">
        <div class="stat-n" id="cnt-e">0</div>
        <div class="stat-l">enemy resp.</div>
      </div>
    </div>
    <div class="ctrl-group">
      <button class="btn friend-btn" onclick="setPhase('friend')">← Friend</button>
      <button class="btn enemy-btn"  onclick="setPhase('enemy')">Enemy →</button>
      <button class="btn primary-btn" id="analyze-btn" onclick="runAnalysis()">Semantic Analysis</button>
      <button class="btn" onclick="addDemo()">+ Demo</button>
      <button class="btn" onclick="clearAll()">Clear all</button>
    </div>
  </div>

  <div class="div-row">
    <div class="div-block">
      <div class="div-lbl">Diversity — Friend</div>
      <div class="div-track"><div class="div-fill friend" id="div-f" style="width:0%"></div></div>
      <div class="div-pct friend" id="div-fv">—</div>
    </div>
    <div class="div-sep"></div>
    <div class="div-block">
      <div class="div-lbl">Diversity — Enemy</div>
      <div class="div-track"><div class="div-fill enemy" id="div-e" style="width:0%"></div></div>
      <div class="div-pct enemy" id="div-ev">—</div>
    </div>
  </div>

  <div class="clouds-wrap">
    <div class="cloud-panel">
      <div class="panel-head">
        <div class="panel-title friend">Friend</div>
        <div class="panel-stats" id="ps-f">—</div>
      </div>
      <div class="cloud-area" id="cloud-f">
        <div class="empty-state" id="empty-f">
          <div class="empty-state-icon">○</div>
          <div class="empty-state-txt">awaiting responses</div>
        </div>
      </div>
      <div class="sidebar-list" id="sb-f"></div>
    </div>
    <div class="cloud-panel">
      <div class="panel-head">
        <div class="panel-title enemy">Enemy</div>
        <div class="panel-stats" id="ps-e">—</div>
      </div>
      <div class="cloud-area" id="cloud-e">
        <div class="empty-state" id="empty-e">
          <div class="empty-state-icon">○</div>
          <div class="empty-state-txt">awaiting responses</div>
        </div>
      </div>
      <div class="sidebar-list" id="sb-e"></div>
    </div>
  </div>
</div>

<!-- ══════════ ANALYSIS OVERLAY ══════════ -->
<div id="analysis-overlay">
  <div id="analysis-panel">
    <div class="analysis-header">
      <div class="analysis-title">Semantic Analysis</div>
      <div class="analysis-actions">
        <button class="btn export-btn" id="export-btn" onclick="exportPNG()" style="display:none">
          ↓ Export PNG for PowerPoint
        </button>
        <button class="btn" onclick="closeAnalysis()">✕ Close</button>
      </div>
    </div>
    <div class="analysis-body" id="analysis-body"></div>
  </div>
</div>

<script>
/* ════════════════════════════════════════════
   SYNONYM CANONICALIZER — English-first
════════════════════════════════════════════ */
const SYNS = {
  'trust':        ['trust','trustworthy','trusting','reliability','reliable','confianza','confiable'],
  'loyalty':      ['loyalty','loyal','faithfulness','faithful','fidelity','lealtad','leal','fiel'],
  'support':      ['support','supportive','backing','help','helpful','apoyo','ayuda','respaldo'],
  'companionship':['companionship','companion','company','togetherness','fellowship','compañía'],
  'love':         ['love','loving','affection','affectionate','care','caring','amor','cariño'],
  'honesty':      ['honesty','honest','sincerity','sincere','truthful','truth','honestidad','sincero'],
  'respect':      ['respect','respectful','regard','respeto'],
  'joy':          ['joy','joyful','happiness','happy','cheerful','alegría','felicidad'],
  'empathy':      ['empathy','empathetic','understanding','compassion','compassionate','empatía'],
  'kindness':     ['kindness','kind','generosity','generous','warmth','warm'],
  'betrayal':     ['betrayal','betray','traitor','treachery','disloyalty','traición','traidor'],
  'envy':         ['envy','envious','jealousy','jealous','envidia','celos'],
  'hatred':       ['hatred','hate','hateful','loathing','odio','rencor'],
  'fear':         ['fear','fearful','terror','dread','miedo','temor','pánico'],
  'rivalry':      ['rivalry','rival','competition','competitor','rivalidad'],
  'deceit':       ['deceit','deceitful','lies','lie','lying','deception','falseness','mentira','engaño'],
  'harm':         ['harm','harmful','hurt','damage','pain','daño','dolor'],
  'conflict':     ['conflict','confrontation','fight','fighting','clash','hostility','conflicto','pelea'],
  'manipulation': ['manipulation','manipulative','manipulate','manipulator','manipulación'],
  'obstacle':     ['obstacle','barrier','hindrance','impediment','obstáculo','barrera'],
  'indifference': ['indifference','indifferent','coldness','cold','indiferencia'],
  'selfishness':  ['selfishness','selfish','self-interest','egoism','egotism'],
};

const RMAP = {};
for (const [c,vs] of Object.entries(SYNS))
  for (const v of vs) RMAP[strip(v)] = c;

function strip(s) {
  return (s||'').toLowerCase().trim()
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .replace(/[^a-z]/g,'');
}
function canon(raw) { return RMAP[strip(raw)] || raw.toLowerCase().trim(); }

/* ════════════════════════════════════════════
   STATE & STORAGE
════════════════════════════════════════════ */
let ST = { phase:'friend', friend:{}, enemy:{} };
let userDone = { friend:false, enemy:false };
const SKEY = 'ponencia_en_v1';
let pollId = null;

async function saveState() {
  try { await window.storage.set(SKEY, JSON.stringify(ST), true); } catch(e){}
}
async function loadState() {
  try {
    const r = await window.storage.get(SKEY, true);
    if (r?.value) {
      const d = JSON.parse(r.value);
      ST.phase  = d.phase  || 'friend';
      ST.friend = d.friend || {};
      ST.enemy  = d.enemy  || {};
    }
  } catch(e){}
}

/* ════════════════════════════════════════════
   TABS
════════════════════════════════════════════ */
let curTab = 'participant';

function switchTab(t) {
  curTab = t;
  document.querySelectorAll('.view').forEach(v=>v.classList.remove('active'));
  document.getElementById(t+'-view').classList.add('active');
  document.getElementById('tab-p').classList.toggle('active', t==='participant');
  document.getElementById('tab-r').classList.toggle('active', t==='presenter');
  if (t==='participant') updateParticipant();
  else renderPresenter();
  startPoll();
}

function startPoll() {
  clearInterval(pollId);
  pollId = setInterval(async () => {
    await loadState();
    curTab==='participant' ? updateParticipant() : renderPresenter();
  }, 3000);
}

/* ════════════════════════════════════════════
   PARTICIPANT
════════════════════════════════════════════ */
function updateParticipant() {
  const isE   = ST.phase==='enemy';
  const done  = userDone[ST.phase];
  const fs    = document.getElementById('form-screen');
  const ws    = document.getElementById('wait-screen');

  if (userDone.friend && userDone.enemy) {
    fs.style.display='none'; ws.classList.add('show');
    document.getElementById('wait-title').textContent='Thank you for participating!';
    document.getElementById('wait-sub').textContent='Watch the results on screen';
    document.getElementById('wait-screen').querySelector('.wait-icon').textContent='✦';
    return;
  }
  if (userDone.friend && !userDone.enemy && ST.phase==='friend') {
    fs.style.display='none'; ws.classList.add('show');
    document.getElementById('wait-title').textContent='Phase 1 complete';
    document.getElementById('wait-sub').textContent='The presenter will activate Phase 2 shortly';
    return;
  }

  ws.classList.remove('show'); fs.style.display='';

  const qt  = document.getElementById('q-text');
  const wf  = document.getElementById('word-field');
  const btn = document.getElementById('submit-btn');
  const st  = document.getElementById('p-status');
  const sd0 = document.getElementById('sd0');
  const sd1 = document.getElementById('sd1');
  const qpl = document.getElementById('q-phase-label');

  qt.textContent = isE ? 'What is an enemy?' : 'What is a friend?';
  qt.className   = 'q-text '+(isE?'enemy':'friend');
  wf.className   = 'word-field '+(isE?'enemy':'');
  btn.className  = 'submit-btn '+(isE?'enemy':'friend');
  qpl.textContent= isE ? 'Phase 2 of 2' : 'Phase 1 of 2';

  wf.disabled  = done;
  btn.disabled = done;
  st.textContent = done ? '✓ Response recorded' : '';
  st.className   = 'p-status'+(done ? ' ok'+(isE?' enemy':'') : '');

  sd0.className='pstrip-dot'+(ST.phase==='friend'?' f-active':' done');
  sd1.className='pstrip-dot'+(ST.phase==='enemy' ?' e-active':'');
}

async function submitWord() {
  const field = document.getElementById('word-field');
  const raw   = field.value.trim();
  if (!raw || raw.length<2) { field.focus(); return; }
  const c = canon(raw);
  const b = ST.phase==='friend' ? ST.friend : ST.enemy;
  b[c] = (b[c]||0)+1;
  userDone[ST.phase] = true;
  await saveState();
  field.value='';
  updateParticipant();
}

document.getElementById('word-field').addEventListener('keydown', e=>{
  if (e.key==='Enter') submitWord();
});

/* ════════════════════════════════════════════
   PRESENTER CONTROLS
════════════════════════════════════════════ */
async function setPhase(p) {
  ST.phase = p; await saveState(); renderPresenter();
}

async function clearAll() {
  if (!confirm('Clear all responses?')) return;
  ST.friend={}; ST.enemy={}; await saveState(); renderPresenter();
}

function addDemo() {
  const fw = ['trust','loyalty','support','love','honesty','respect','empathy',
               'trust','loyalty','support','trust','love','trust','loyalty',
               'support','respect','sincerity','companionship','kindness','care'];
  const ew = ['betrayal','envy','hatred','fear','rivalry','deceit','harm',
               'conflict','manipulation','obstacle','loneliness','resentment',
               'bitterness','ingratitude','rejection','indifference','selfishness',
               'cruelty','dishonesty','exploitation','abuse','jealousy'];
  fw.forEach(w=>{ ST.friend[w]=(ST.friend[w]||0)+1; });
  ew.forEach(w=>{ ST.enemy[w] =(ST.enemy[w]||0)+1; });
  saveState(); renderPresenter();
}

/* ════════════════════════════════════════════
   PRESENTER RENDER
════════════════════════════════════════════ */
function totalW(m) { return Object.values(m).reduce((a,b)=>a+b,0); }
function diversityPct(m) {
  const t=totalW(m), u=Object.keys(m).length;
  return t ? Math.round((u/t)*100) : 0;
}

function renderPresenter() {
  const isE = ST.phase==='enemy';
  const pill = document.getElementById('phase-pill');
  pill.className = 'phase-pill '+(isE?'enemy':'friend');
  document.getElementById('phase-pill-text').textContent = isE ? 'Phase: Enemy' : 'Phase: Friend';

  const tf=totalW(ST.friend), te=totalW(ST.enemy);
  document.getElementById('cnt-f').textContent=tf;
  document.getElementById('cnt-e').textContent=te;

  const df=diversityPct(ST.friend), de=diversityPct(ST.enemy);
  document.getElementById('div-f').style.width  = df+'%';
  document.getElementById('div-fv').textContent = tf?df+'%':'—';
  document.getElementById('div-e').style.width  = de+'%';
  document.getElementById('div-ev').textContent = te?de+'%':'—';

  renderCloud('f', ST.friend, 'var(--friend)', '#1a6b3c33');
  renderCloud('e', ST.enemy,  'var(--enemy)',  '#b5261e33');
}

function renderCloud(id, data, color, glow) {
  const area   = document.getElementById('cloud-'+id);
  const sb     = document.getElementById('sb-'+id);
  const ps     = document.getElementById('ps-'+id);
  const empty  = document.getElementById('empty-'+id);

  const words = Object.entries(data).sort((a,b)=>b[1]-a[1]);
  const t=totalW(data), u=words.length;

  ps.textContent = t ? `${t} responses · ${u} unique` : '—';
  empty.style.display = u?'none':'flex';
  area.querySelectorAll('.word-tag').forEach(el=>el.remove());

  sb.innerHTML = words.map(([w,c])=>`
    <div class="sitem" style="color:${color}">
      <span class="sitem-w">${w}</span>
      <span class="sitem-c">${c}</span>
    </div>`).join('');

  if (!u) return;

  const W=area.offsetWidth||400, H=area.offsetHeight||260;
  const maxC=words[0][1];
  const placed=[];
  const ROTS=[-15,-8,-3,0,0,0,3,8,15];

  words.forEach(([word,count],i) => {
    const ratio=count/maxC;
    const fs=Math.round(Math.max(10,Math.min(W*.12,13+ratio*(W*.075))));
    const op=0.25+ratio*.75;
    const rot=ROTS[i%ROTS.length];

    const el=document.createElement('span');
    el.className='word-tag';
    el.textContent=word;
    el.style.setProperty('--wr',rot+'deg');
    el.style.setProperty('--wo',op);
    el.style.fontSize=fs+'px';
    el.style.color=color;
    el.style.opacity=op;
    el.style.animationDelay=(i*.04)+'s';
    if(ratio>.5) el.style.textShadow=`0 0 ${fs*.5}px ${glow}`;

    el.style.visibility='hidden'; el.style.left='0'; el.style.top='0';
    area.appendChild(el);
    const ew=el.offsetWidth+10, eh=el.offsetHeight+8;
    el.style.visibility='';

    let best=null;
    for(let a=0;a<120;a++){
      const x=Math.random()*Math.max(1,W-ew-110);
      const y=Math.random()*Math.max(1,H-eh);
      let ok=true;
      for(const p of placed){
        if(x<p.x+p.w&&x+ew>p.x&&y<p.y+p.h&&y+eh>p.y){ok=false;break;}
      }
      if(ok){best={x,y};break;}
    }
    if(!best) best={x:Math.random()*Math.max(1,W-ew-110),y:Math.random()*Math.max(1,H-eh)};
    placed.push({x:best.x,y:best.y,w:ew,h:eh});
    el.style.left=best.x+'px'; el.style.top=best.y+'px';
    el.style.transform=`rotate(${rot}deg)`;
  });
}

/* ════════════════════════════════════════════
   SEMANTIC ANALYSIS — Claude API
════════════════════════════════════════════ */
async function runAnalysis() {
  const fWords = Object.entries(ST.friend);
  const eWords = Object.entries(ST.enemy);

  if (!fWords.length && !eWords.length) {
    alert('No responses yet. Use + Demo to add sample words.'); return;
  }

  const overlay = document.getElementById('analysis-overlay');
  const body    = document.getElementById('analysis-body');
  const expBtn  = document.getElementById('export-btn');

  overlay.classList.add('show');
  expBtn.style.display='none';
  body.innerHTML = `
    <div class="analysis-loading">
      <div class="spinner"></div>
      <div class="loading-txt">Running semantic analysis…</div>
    </div>`;

  const prompt = `You are a linguist and social psychologist. Analyse these responses from an academic audience at Imperial College London to two questions: "What is a friend?" and "What is an enemy?".

FRIEND responses (word: frequency):
${fWords.map(([w,c])=>`${w}: ${c}`).join(', ')||'(none)'}

ENEMY responses (word: frequency):
${eWords.map(([w,c])=>`${w}: ${c}`).join(', ')||'(none)'}

Respond ONLY with a valid JSON object, no extra text, with this exact structure:
{
  "friend_clusters": [
    { "name": "cluster name", "words": ["word1","word2"], "description": "brief description in English" }
  ],
  "enemy_clusters": [
    { "name": "cluster name", "words": ["word1","word2"], "description": "brief description in English" }
  ],
  "metrics": {
    "friend_unique": number,
    "friend_total": number,
    "friend_clusters_n": number,
    "friend_entropy": number between 0 and 10,
    "enemy_unique": number,
    "enemy_total": number,
    "enemy_clusters_n": number,
    "enemy_entropy": number between 0 and 10
  },
  "insight": "An academic observation about the difference in semantic dispersion between both concepts (2-3 sentences in English)",
  "scatter_points": [
    { "word": "word", "type": "friend", "x": number between -1 and 1, "y": number between -1 and 1, "cluster": "cluster name", "size": number between 1 and 5 }
  ]
}

For scatter_points: position friend words on the left side of the space (-1 to 0 in X) clustered together, and enemy words on the right (0 to 1 in X) more dispersed. Use coordinates that reflect real semantic similarity.`;

  try {
    const res = await fetch('https://api.anthropic.com/v1/messages', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        model:'claude-sonnet-4-20250514',
        max_tokens:1000,
        messages:[{role:'user',content:prompt}]
      })
    });

    if (!res.ok) throw new Error(`API error ${res.status}`);
    const data = await res.json();
    const raw  = data.content?.[0]?.text||'';
    const json = raw.replace(/```json|```/g,'').trim();
    const analysis = JSON.parse(json);

    renderAnalysis(analysis);
    expBtn.style.display='';

  } catch(err) {
    body.innerHTML=`
      <div class="analysis-error">
        Could not reach the Claude API: ${err.message}<br><br>
        <small style="font-family:var(--mono);font-size:10px;color:var(--ink3)">
          Check your internet connection and try again.
        </small>
      </div>`;
  }
}

function renderAnalysis(a) {
  const body = document.getElementById('analysis-body');
  const m    = a.metrics || {};

  const clusterHTML = (clusters, type) => clusters.map(c=>`
    <div class="cluster-card">
      <div class="cluster-card-head ${type}">${type==='friend'?'Friend':'Enemy'} · ${c.name}</div>
      <div class="cluster-item">
        <div class="cluster-name" style="color:var(--${type})">${c.name}</div>
      </div>
      <div class="cluster-words">${c.words.join(' · ')}</div>
      <div style="font-family:var(--serif);font-size:12px;color:var(--ink3);margin-top:8px;font-style:italic">${c.description}</div>
    </div>`).join('');

  const fe = (m.friend_entropy||0).toFixed(1);
  const ee = (m.enemy_entropy ||0).toFixed(1);
  const fePct = Math.min(100, (m.friend_entropy||0)/10*100);
  const eePct = Math.min(100, (m.enemy_entropy ||0)/10*100);

  body.innerHTML = `
    <canvas id="scatter-canvas" height="320"></canvas>

    <div>
      <div style="font-family:var(--mono);font-size:8px;letter-spacing:3px;color:var(--ink3);text-transform:uppercase;margin-bottom:12px">Semantic Dispersion Metrics</div>
      <div class="metrics-row">
        <div class="metric-card">
          <div class="metric-val friend">${m.friend_clusters_n||0}</div>
          <div class="metric-lbl">Friend clusters</div>
          <div class="metric-note">semantic groups</div>
        </div>
        <div class="metric-card">
          <div class="metric-val enemy">${m.enemy_clusters_n||0}</div>
          <div class="metric-lbl">Enemy clusters</div>
          <div class="metric-note">semantic groups</div>
        </div>
        <div class="metric-card">
          <div class="metric-val friend">${m.friend_unique||0}</div>
          <div class="metric-lbl">Unique words — Friend</div>
          <div class="metric-note">of ${m.friend_total||0} responses</div>
        </div>
        <div class="metric-card">
          <div class="metric-val enemy">${m.enemy_unique||0}</div>
          <div class="metric-lbl">Unique words — Enemy</div>
          <div class="metric-note">of ${m.enemy_total||0} responses</div>
        </div>
      </div>
    </div>

    <div>
      <div style="font-family:var(--mono);font-size:8px;letter-spacing:3px;color:var(--ink3);text-transform:uppercase;margin-bottom:12px">Semantic Entropy</div>
      <div style="display:flex;flex-direction:column;gap:10px">
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-family:var(--mono);font-size:9px;color:var(--friend);width:80px">FRIEND</div>
          <div style="flex:1;height:6px;background:var(--rule);border-radius:3px;overflow:hidden">
            <div style="height:100%;width:${fePct}%;background:var(--friend);border-radius:3px;transition:width 1s"></div>
          </div>
          <div style="font-family:var(--mono);font-size:11px;color:var(--friend);width:30px;text-align:right">${fe}</div>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div style="font-family:var(--mono);font-size:9px;color:var(--enemy);width:80px">ENEMY</div>
          <div style="flex:1;height:6px;background:var(--rule);border-radius:3px;overflow:hidden">
            <div style="height:100%;width:${eePct}%;background:var(--enemy);border-radius:3px;transition:width 1s"></div>
          </div>
          <div style="font-family:var(--mono);font-size:11px;color:var(--enemy);width:30px;text-align:right">${ee}</div>
        </div>
      </div>
    </div>

    <div>
      <div style="font-family:var(--mono);font-size:8px;letter-spacing:3px;color:var(--ink3);text-transform:uppercase;margin-bottom:12px">Identified Clusters</div>
      <div class="clusters-grid">
        ${clusterHTML(a.friend_clusters||[],'friend')}
        ${clusterHTML(a.enemy_clusters||[],'enemy')}
      </div>
    </div>

    <div style="background:white;border:1px solid var(--rule);border-radius:2px;padding:20px;border-left:3px solid var(--accent)">
      <div style="font-family:var(--mono);font-size:8px;letter-spacing:3px;color:var(--accent);text-transform:uppercase;margin-bottom:8px">Academic Insight</div>
      <div style="font-family:var(--serif);font-size:17px;line-height:1.65;color:var(--ink2);font-style:italic">${a.insight||''}</div>
    </div>
  `;

  drawScatter(a.scatter_points||[]);
}

function drawScatter(points) {
  const canvas = document.getElementById('scatter-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.offsetWidth;
  canvas.width = W; canvas.height = 320;
  const H = 320;
  const PAD = 40;

  ctx.fillStyle='#faf9f6'; ctx.fillRect(0,0,W,H);

  ctx.strokeStyle='#dddad3'; ctx.lineWidth=1;
  ctx.setLineDash([4,4]);
  ctx.beginPath(); ctx.moveTo(W/2,PAD); ctx.lineTo(W/2,H-PAD); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(PAD,H/2); ctx.lineTo(W-PAD,H/2); ctx.stroke();
  ctx.setLineDash([]);

  ctx.font='9px DM Mono, monospace';
  ctx.fillStyle='#1a6b3c'; ctx.textAlign='center';
  ctx.fillText('FRIEND — more cohesive', W/4, PAD-10);
  ctx.fillStyle='#b5261e';
  ctx.fillText('ENEMY — more dispersed', W*3/4, PAD-10);

  points.forEach(p => {
    const x = PAD + ((p.x+1)/2) * (W-2*PAD);
    const y = PAD + ((1-(p.y+1)/2)) * (H-2*PAD);
    const r = 4 + (p.size||1)*1.5;
    const isF = p.type==='friend';
    const color = isF ? '#1a6b3c' : '#b5261e';
    const bg    = isF ? '#e8f5ee' : '#fbeaea';

    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fillStyle=bg; ctx.fill();
    ctx.strokeStyle=color; ctx.lineWidth=1.5; ctx.stroke();

    ctx.font=`${Math.max(8,8+(p.size||1))}px EB Garamond, serif`;
    ctx.fillStyle=color; ctx.textAlign='left';
    ctx.fillText(p.word, x+r+3, y+4);
  });
}

/* ════════════════════════════════════════════
   EXPORT PNG
════════════════════════════════════════════ */
async function exportPNG() {
  const scatterCanvas = document.getElementById('scatter-canvas');
  if (!scatterCanvas) return;

  const exp = document.createElement('canvas');
  exp.width  = scatterCanvas.width;
  exp.height = scatterCanvas.height + 60;
  const ctx  = exp.getContext('2d');

  ctx.fillStyle='#faf9f6'; ctx.fillRect(0,0,exp.width,exp.height);

  ctx.font='bold 16px EB Garamond, serif';
  ctx.fillStyle='#0f0e0c'; ctx.textAlign='center';
  ctx.fillText('Semantic Dispersion: Friend vs Enemy', exp.width/2, 28);
  ctx.font='10px DM Mono, monospace';
  ctx.fillStyle='#8a857a';
  ctx.fillText('Imperial College London · ' + new Date().toLocaleDateString('en-GB'), exp.width/2, 46);

  ctx.drawImage(scatterCanvas, 0, 60);

  const link = document.createElement('a');
  link.download='friend-enemy-scatter.png';
  link.href = exp.toDataURL('image/png');
  link.click();
}

function closeAnalysis() {
  document.getElementById('analysis-overlay').classList.remove('show');
}

/* ════════════════════════════════════════════
   INIT
════════════════════════════════════════════ */
(async () => {
  await loadState();
  updateParticipant();
  startPoll();
})();
</script>
</body>
</html>
